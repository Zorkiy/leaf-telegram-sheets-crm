#!/bin/bash

# –ó—É–ø–∏–Ω—è—î–º–æ —Å–∫—Ä–∏–ø—Ç –ø—Ä–∏ –ø–µ—Ä—à—ñ–π –ø–æ–º–∏–ª—Ü—ñ
set -e

echo "üîß –ü–æ—á–∏–Ω–∞—î–º–æ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø—É..."

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, –¥–µ –º–∏ –∑–Ω–∞—Ö–æ–¥–∏–º–æ—Å—å (–º–∞—î–º–æ –±—É—Ç–∏ –≤ –∫–æ—Ä–µ–Ω—ñ –ø—Ä–æ—î–∫—Ç—É)
if [ ! -f "docker-compose.yml" ]; then
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞: –ó–∞–ø—É—Å—Ç—ñ—Ç—å —Ü–µ–π —Å–∫—Ä–∏–ø—Ç –∑ –∫–æ—Ä–µ–Ω—è –ø—Ä–æ—î–∫—Ç—É (./bin/fix-perms.sh)"
    exit 1
fi

# 1. –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –≤–ª–∞—Å–Ω–∏–∫–∞ —É—Å—ñ—Ö —Ñ–∞–π–ª—ñ–≤ –ø–æ—Ç–æ—á–Ω–æ–º—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É
# –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ sudo, —â–æ–± –∑–∞–±—Ä–∞—Ç–∏ –ø—Ä–∞–≤–∞ —É root (—è–∫—â–æ —Ñ–∞–π–ª–∏ —Å—Ç–≤–æ—Ä–∏–≤ Docker)
# $(id -gn) –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—ñ–¥—Å—Ç–∞–≤–∏—Ç—å –≤–∞—à—É –æ—Å–Ω–æ–≤–Ω—É –≥—Ä—É–ø—É
echo "üë§ 1. –ó–º—ñ–Ω–∞ –≤–ª–∞—Å–Ω–∏–∫–∞ –Ω–∞ $USER..."
sudo chown -R "$USER:$(id -gn)" .

# 2. –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ñ –±–µ–∑–ø–µ—á–Ω—ñ –ø—Ä–∞–≤–∞
echo "üìÇ 2. –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏—Ö –ø—Ä–∞–≤ (755 –¥–ª—è –ø–∞–ø–æ–∫, 644 –¥–ª—è —Ñ–∞–π–ª—ñ–≤)..."
find . -type d -exec chmod 755 {} \;
find . -type f -exec chmod 644 {} \;

# 3. –î–æ–∑–≤–æ–ª—è—î–º–æ –∑–∞–ø–∏—Å —É —Å–ø–µ—Ü–∏—Ñ—ñ—á–Ω—ñ –ø–∞–ø–∫–∏
# SQLite –ø–æ—Ç—Ä–µ–±—É—î –∑–∞–ø–∏—Å—É –≤ –ø–∞–ø–∫—É –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è -wal —Ç–∞ -shm —Ñ–∞–π–ª—ñ–≤
echo "üìù 3. –ù–∞–¥–∞–Ω–Ω—è –ø—Ä–∞–≤ –Ω–∞ –∑–∞–ø–∏—Å –¥–ª—è DB —Ç–∞ Logs..."
chmod -R 775 db
chmod -R 775 logs

# 4. –†–æ–±–∏–º–æ —Å–∫—Ä–∏–ø—Ç–∏ –≤ bin –≤–∏–∫–æ–Ω—É–≤–∞–Ω–∏–º–∏ (–≤–∫–ª—é—á–∞—é—á–∏ —Ü–µ–π)
echo "üöÄ 4. –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–∞–≤ –¥–ª—è —Å–∫—Ä–∏–ø—Ç—ñ–≤..."
chmod +x bin/*

echo "‚úÖ –ì–æ—Ç–æ–≤–æ! –ü—Ä–∞–≤–∞ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ —ñ–¥–µ–∞–ª—å–Ω–æ."
